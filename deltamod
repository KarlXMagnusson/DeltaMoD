#!/bin/bash
# DeltaMoD smart wrapper script
# Automatically handles relative paths in config files by running from the config's directory.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export DYLD_LIBRARY_PATH="${SCRIPT_DIR}/gecode:${SCRIPT_DIR}/libxml2/build/lib:${SCRIPT_DIR}/boost/build/lib:${DYLD_LIBRARY_PATH}"

# Check for config file argument
CONFIG_FILE=""
ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -c|--config)
      CONFIG_FILE="$2"
      shift 2
      ;;
    *)
      ARGS+=("$1")
      shift
      ;;
  esac
done

if [ -n "$CONFIG_FILE" ] && [ -f "$CONFIG_FILE" ]; then
  # Resolve absolute path to config
  ABS_CONFIG="$(cd "$(dirname "$CONFIG_FILE")" && pwd)/$(basename "$CONFIG_FILE")"
  CONFIG_DIR="$(dirname "$ABS_CONFIG")"
  CONFIG_NAME="$(basename "$ABS_CONFIG")"
  
  # cd to the config directory so relative paths in the config file (e.g. ./sdfs/) work
  cd "$CONFIG_DIR"
  "${SCRIPT_DIR}/bin/adse" -c "$CONFIG_NAME" "${ARGS[@]}"
else
  # If no config or config is passed via other means, just run normally
  if [ -n "$CONFIG_FILE" ]; then
    "${SCRIPT_DIR}/bin/adse" -c "$CONFIG_FILE" "${ARGS[@]}"
  else
    "${SCRIPT_DIR}/bin/adse" "${ARGS[@]}"
  fi
fi
